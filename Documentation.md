FitnessBot: Вес-контроль
Телеграм-бот для отслеживания физической активности и питания
Техническая документация проекта
________________________________________
1. Введение
1.1. Назначение системы
FitnessBot — это телеграм-бот, предназначенный для комплексного мониторинга здоровья пользователя через отслеживание физической активности и питания. 
Система позволяет:
•	Фиксировать ежедневную активность (шаги, активные минуты, сожжённые калории)
•	Вести дневник питания с учётом калорий и макронутриентов (белки, жиры, углеводы)
•	Распознавать блюда по фотографиям с помощью искусственного интеллекта
•	Устанавливать и контролировать выполнение дневных целей
•	Рассчитывать индекс массы тела (BMI) и отслеживать его динамику
•	Получать персонализированные напоминания о приёмах пищи и активности
•	Визуализировать прогресс через графики и отчёты
•	Синхронизировать данные с Google Fit
1.2. Целевая аудитория
•	Люди, следящие за своим здоровьем и физической формой
•	Пользователи, желающие контролировать калорийность питания
•	Спортсмены-любители, отслеживающие активность
•	Люди с избыточным весом, стремящиеся к нормализации массы тела
1.3. Технологический стек
•	Язык программирования: C# (.NET)
•	База данных: PostgreSQL
•	ORM: LinqToDB
•	Telegram Bot API: Telegram.Bot (официальная библиотека)
•	AI-сервис для распознавания еды: LogMeal API
•	Сервис визуализации: QuickChart API
•	Интеграция фитнес-данных: Google Fit API
•	Архитектурный подход: многослойная архитектура с разделением на Core, Infrastructure, Application layers
________________________________________
2. Архитектура системы
2.1. Общая структура
Проект организован по принципу многослойной (layered) архитектуры с чётким разделением ответственности:
FitnessBot/
├── Core/                           # Ядро системы
│   ├── Entities/                   # Доменные сущности
│   ├── Abstractions/               # Интерфейсы репозиториев
│   ├── Services/                   # Бизнес-логика и сервисы
│   │   └── LogMeal/               # Интеграция с LogMeal API
│   └── DataAccess/Models                 # Модели БД
├── Infrastructure/                 # Инфраструктурный слой
│   └── DataAccess/                # Реализация репозиториев (PostgreSQL)
├── Scenarios/                      # Сценарии диалогов с пользователем
├── TelegramBot/                    # Обработка Telegram-событий
│   └── Handlers/                  # Command, Callback и Photo handlers
│   └── DTO/		# CallbackDto, AdminUserCallbackDto, MealCaloriesCallbackDto
├── BackgroundTasks/                # Фоновые задачи
└── Program.cs                      # Точка входа приложения
2.2. Слой доменных сущностей (Core.Entities)
Содержит основные бизнес-объекты системы:
User — Пользователь
Хранит профиль пользователя и его настройки:
•	Базовая информация: TelegramId, Name, Age, City
•	Физические параметры: HeightCm, WeightKg
•	Настройки времени приёмов пищи: BreakfastTime, LunchTime, DinnerTime
•	Флаги напоминаний: ActivityRemindersEnabled, MorningReminderEnabled и др.
•	Роль в системе: UserRole (User/Admin)
•	Токен синхронизации: GoogleFitRefreshToken, GoogleFitRefreshToken
Meal — Приём пищи
Описывает один приём пищи:
•	UserId — владелец записи
•	DateTime — время приёма
•	MealType — тип (breakfast, lunch, dinner, snack)
•	Calories — калорийность
•	Protein, Fat, Carbs — макронутриенты
•	PhotoUrl — ссылка на фото блюда (опционально)
Activity — Активность
Хранит данные об активности за день:
•	UserId — владелец записи
•	Date — дата
•	Steps — количество шагов
•	ActiveMinutes — активные минуты
•	CaloriesBurned — сожжённые калории
•	Source — источник данных (manual, googlefit)
DailyGoal — Дневная цель
Целевые показатели на день:
•	TargetSteps — целевое количество шагов
•	TargetCaloriesIn — целевое потребление калорий
•	TargetCaloriesOut — целевой расход калорий
•	IsCompleted — флаг выполнения
•	CompletedAt — время выполнения
BmiRecord — Измерение индекса массы тела
История измерений индекса массы тела:
•	HeightCm, WeightKg — исходные данные
•	Bmi — рассчитанный индекс массы тела
•	Category — категория (Underweight, Normal, Overweight, Obese)
•	Recommendation — текстовая рекомендация
•	MeasuredAt — время измерения
Notification — Уведомление
Система отложенных уведомлений:
•	Type — тип уведомления (BreakfastReminder, DailyGoalAchieved и др.)
•	Text — текст сообщения
•	ScheduledAt — время планируемой отправки
•	IsSent — флаг отправки
•	SentAt — фактическое время отправки
Служебные сущности
•	ErrorLog — логи ошибок системы
•	ChangeLog — история изменений данных
•	ContentItem — загруженный контент (фото, файлы)
2.3. Слой абстракций (Core.Abstractions)
Определяет интерфейсы для доступа к данным, обеспечивая слабую связанность:
•	IUserRepository — работа с пользователями
•	IMealRepository — работа с приёмами пищи
•	IActivityRepository — работа с активностью
•	IDailyGoalRepository — работа с целями
•	IBmiRepository — работа с измерениями индекса массы тела
•	INotificationRepository — работа с уведомлениями
•	IAdminStatsRepository — статистика для администраторов
•	IErrorLogRepository — логирование ошибок
•	IContentItemRepository — управление контентом
2.4. Слой бизнес-логики (Core.Services)
Основные сервисы
UserService
•	Регистрация и обновление пользователей (RegisterOrUpdateAsync)
•	Получение пользователя по TelegramId или внутреннему Id
•	Управление ролями (MakeAdminAsync, MakeUserAsync)
•	Подсчёт активных пользователей
•	Обновление настроек профиля
NutritionService
•	Добавление приёма пищи (AddMealAsync)
•	Получение списка приёмов за период
•	Вычисление суммарных калорий и БЖУ (GetTotalsAsync)
•	Фильтрация по типу приёма пищи
ActivityService
•	Добавление записи активности
•	Получение активности за период
•	Подсчёт суммарных калорий, сожжённых за период
•	Агрегация данных для отчётов
BmiService
•	Расчёт ИМТ по формуле: вес(кг) / (рост(м))²
•	Определение категории:
•	< 18.5: Недостаточный вес
•	18.5-24.9: Нормальный вес
•	25-29.9: Избыточный вес
•	≥ 30: Ожирение
•	Формирование персональных рекомендаций
•	Сохранение измерения (SaveMeasurementAsync)
•	Получение истории измерений
ReportService
•	Формирование текстовых отчётов за период
•	Агрегация данных по калориям вход/выход
•	Расчёт баланса калорий
•	Суммирование макронутриентов (БЖУ)
NotificationService
•	Планирование уведомлений (ScheduleAsync)
•	Получение просроченных уведомлений (GetDueAsync)
•	Пометка как отправленных (MarkSentAsync)
•	Проверка выполнения дневных целей
Сервисы визуализации
ChartDataService
Агрегирует данные для построения графиков:
•	Калории по дням (вход/выход)
•	Шаги по дням
•	Макронутриенты по дням
ChartService
Формирует URL для QuickChart API:
•	GenerateCaloriesChartUrl — линейный график калорий
•	GenerateStepsChartUrl — столбчатый график шагов с линией цели
•	GenerateMacrosChartUrl — столбчатый график БЖУ
ChartImageService
Скачивает изображения графиков по URL для отправки пользователю.
Административные сервисы
AdminAnalyticsService
•	Получение активных пользователей за день
•	Агрегация логов ошибок
•	Статистика по контенту
AdminStatsService
•	Распределение пользователей по возрасту (<18, 18-29, 30-44, 45-59, 60+)
•	Распределение по городам
•	Общее количество пользователей
2.5. Интеграция с внешними сервисами
LogMeal API — Распознавание еды по фото
Назначение: AI-сервис для идентификации блюд и ингредиентов на фотографиях.
LogMealClient (Core/Services/LogMeal/LogMealClient.cs):
public async Task<LogMealSegmentationResult?> AnalyzeSegmentationAsync(
    Stream imageStream,string fileName,  CancellationToken ct = default)
Модель результатов:
NutritionalInfo:
•	EnergyKcal — калории
•	Proteins, Fats, Carbs — макронутриенты

Обработка фото: FoodPhotoHandler
         1. Скачивание фото от пользователя
        2. Отправка в LogMeal API
         3. Анализ результата
         4. Если нутриенты получены — создание Meal
         5. Если нет — предложение ручного ввода
Google Fit API — Синхронизация активности
Назначение: Автоматическое получение данных о шагах, активных минутах и калориях из Google Fit.
GoogleFitClient (Core/Services/GoogleFitClient.cs):
•	OAuth 2.0 аутентификация
•	Получение токена доступа по refresh token
•	Запрос данных активности за период
•	Маппинг в сущность Activity
GoogleFitSyncBackgroundTask:
Периодически синхронизирует данные для пользователей с подключённым Google Fit:
Для каждого пользователя с GoogleFitRefreshToken:
1. Получить данные за последние сутки
2. Создать/обновить Activity с source="googlefit"
3. Обработать ошибки и недействительные токены
2.6. Слой доступа к данным (Infrastructure.DataAccess)
Технология: LinqToDB — ORM для работы с PostgreSQL
Репозитории:
Каждый репозиторий реализует интерфейс из Core.Abstractions и выполняет маппинг между доменными сущностями и моделями БД.
Схема БД PostgreSQL:
Основные таблицы:
•	users — пользователи
•	meals — приёмы пищи
•	activities — активность
•	daily_goals — дневные цели
•	bmi_records — измерения BMI
•	notifications — уведомления
•	error_logs — логи ошибок
•	change_logs — история изменений
•	content_items — загруженный контент
________________________________________
3. Система сценариев диалога
3.1. Механизм сценариев
Концепция: Многошаговые диалоги с пользователем, где каждый шаг запрашивает определённую информацию и переводит пользователя на следующий этап.
3.2. Описание основных сценариев
RegistrationScenario
Цель: Первичная регистрация нового пользователя.
Шаги:
1.	Приветствие и запрос возраста
2.	Валидация возраста (18-120 лет), сохранение в контекст
3.	Запрос города проживания
4.	Сохранение в User через UserService
5.	Завершение с приветственным сообщением
BmiScenario
Цель: Расчёт индекса массы тела.
Шаги:
1.	Запрос роста в сантиметрах
2.	Валидация роста (100-250 см)
3.	Запрос веса в килограммах
4.	Валидация веса (30-300 кг)
5.	Вызов BmiService.SaveMeasurementAsync
6.	Отправка результата: ИМТ, категория, рекомендации
CustomCaloriesScenario
Цель: Быстрое добавление калорий с опциональным вводом БЖУ.
Шаги:
1.	Запрос количества калорий
2.	Валидация (калории > 0)
3.	Вопрос о желании ввести БЖУ (ReplyKeyboard с кнопками «Да»/«Нет»)
4.	Если «Да» — последовательный ввод белков, жиров, углеводов (с валидацией на каждом шаге)
5.	Создание Meal с MealType="snack"
6.	Сохранение через NutritionService
7.	Подтверждение с итоговыми данными
AddMealScenario
Цель: Детальное добавление приёма пищи.
Шаги:
1.	Выбор режима (ReplyKeyboard):
•	«Готовое блюдо (БЖУ на порцию)»
•	«По 100 г продукта»
2.	Выбор типа приёма пищи (завтрак/обед/ужин/перекус)
Режим 1 — Готовое блюдо:
•	Запрос названия блюда
•	Запрос калорий на порцию
•	Запрос белков, жиров, углеводов
•	Сохранение Meal
Режим 2 — По 100 г продукта:
•	Запрос строки формата: название; ккал; белки; жиры; углеводы
•	Парсинг и валидация
•	Запрос массы съеденного продукта в граммах
•	Пересчёт нутриентов: значение_на_100г * (граммы / 100)
•	Сохранение Meal
EditProfileScenario
Цель: Комплексное редактирование профиля.
Шаги:
1.	Запрос возраста
2.	Запрос роста
3.	Запрос веса
4.	Запрос города
5.	Сохранение через UserService
6.	Если введены рост и вес — автоматический вызов BmiService для сохранения нового измерения
MealTimeSetupScenario
Цель: Настройка времени приёмов пищи для напоминаний.
Шаги:
1.	Запрос времени завтрака (формат HHmm, например 0800)
2.	Валидация и сохранение в User.BreakfastTime
3.	Запрос времени обеда
4.	Сохранение в User.LunchTime
5.	Запрос времени ужина
6.	Сохранение в User.DinnerTime
7.	Подтверждение сохранения расписания
SetDailyGoalScenario
Цель: Установка целей на день.
Шаги:
1.	Запрос целевого количества шагов
2.	Валидация (1000-50000)
3.	Запрос целевого потребления калорий
4.	Валидация (500-5000)
5.	Запрос целевого расхода калорий
6.	Валидация (500-5000)
7.	Создание DailyGoal на текущую дату
8.	Сохранение через IDailyGoalRepository
ActivityReminderSettingsScenario
Цель: Настройка напоминаний об активности.
Функциональность:
Использует inline-кнопки для включения/выключения:
•	Всех напоминаний целиком
•	Утренних напоминаний (9:00)
•	Обеденных напоминаний (13:00)
•	Дневных напоминаний (16:00)
•	Вечерних напоминаний (19:00)
Обновляет флаги в User через UserService.
ConnectGoogleFitScenario
Цель: Подключение аккаунта Google Fit.
Процесс:
1.	Генерация OAuth URL для авторизации
2.	Отправка пользователю ссылки
3.	Ожидание authorization code
4.	Обмен кода на access и refresh tokens
5.	Сохранение GoogleFitRefreshToken в User
6.	Подтверждение успешного подключения
PhotoMealGramsScenario
Цель: Ввод массы для блюда, распознанного по фото.
Контекст использования: Если LogMeal распознал блюдо, но не предоставил точную массу порции.
Шаги:
1.	Запрос массы порции в граммах
2.	Валидация (10-2000 г)
3.	Пересчёт калорий/БЖУ на указанную массу
4.	Сохранение Meal
________________________________________
4. Обработка событий Telegram
4.1. UpdateHandler — центральный диспетчер
Принцип работы:
OnMessage — обработка текстовых сообщений и фото:
1.	Извлечение TelegramId пользователя
2.	Загрузка/создание User через UserService
3.	Проверка типа сообщения:
•	Фото → передача в IPhotoHandler[] (FoodPhotoHandler)
•	Текст → дальнейшая обработка
4.	Загрузка ScenarioContext
5.	Если /cancel и есть активный сценарий → сброс контекста
6.	Если есть активный сценарий → ProcessScenario
7.	Если сценария нет → HandleCommand
OnCallbackQuery — обработка нажатий inline-кнопок:
1.	Извлечение callback data
2.	Загрузка User
3.	Передача в цепочку ICallbackHandler[]
4.	Первый handler, вернувший true, завершает обработку
4.2. Command Handlers
UserCommandsHandler
Обрабатывает команды обычных пользователей:
•	/start — главное меню с ReplyKeyboard
•	/help — справка по командам
•	/today — статистика за сегодня (калории, шаги, баланс)
•	/report — отчёт за период
•	/bmi — запуск BmiScenario
•	/addcalories — запуск CustomCaloriesScenario
•	/addmeal — запуск AddMealScenario
•	/foodphoto — инструкция по отправке фото блюда
•	/setgoal — запуск SetDailyGoalScenario
•	/setmeals — запуск MealTimeSetupScenario
•	/activity_reminders — запуск ActivityReminderSettingsScenario
•	/charts — меню выбора графиков
•	/edit_profile — запуск EditProfileScenario
•	/connectgooglefit — запуск ConnectGoogleFitScenario
Обработка кнопок главного меню:
Использует Contains для распознавания текста кнопок:
•	«📊 Сегодня» → /today
•	«🍽️ Добавить еду» → /addcalories
•	«🥗 Приём пищи» → /addmeal
•	«📷 Распознать блюдо по фото» → /foodphoto
•	И т.д.
AdminCommandsHandler
Обрабатывает команды администраторов:
•	/admin_activity — активные пользователи за период
•	/admin_find <имя> — поиск пользователя
•	/make_admin <telegram_id> — назначение админа
•	/make_user <telegram_id> — снятие прав админа
•	Кнопки «👨‍💼 Админ: Пользователи» и «📊 Админ: Статистика»
ChartsCommandsHandler
Специализированный handler для графиков:
•	/chart_calories [days] — график калорий за N дней (по умолчанию 7)
•	/chart_steps [days] — график шагов
•	/chart_macros [days] — график БЖУ
4.3. Callback Handlers
MealCallbackHandler
Обрабатывает callback data с префиксом meal_:
meal_add_calories:{telegramId}:{calories}
•	Быстрое добавление калорий из пресета (50/100/200/300/500)
•	Создание Meal с MealType="snack"
•	Ответ с подтверждением
meal_add_custom:{telegramId}
•	Запуск CustomCaloriesScenario для ввода произвольного количества калорий
CustomCaloriesCallbackHandler
calories_macros_yes:{userId}
•	Пользователь выбрал «Да» на вопрос о БЖУ
•	Переход на шаг ввода белков в CustomCaloriesScenario
calories_macros_no:{userId}
•	Пользователь выбрал «Нет»
•	Сохранение Meal только с калориями (БЖУ = 0)
•	Завершение сценария
ChartCallbackHandler
•	Генерация графика калорий за указанное количество дней
•	Отправка изображения пользователю
________________________________________
6. Визуализация данных
6.1. Архитектура построения графиков
ChartDataService собирает данные для графиков/
6.2. ChartService — формирование URL для QuickChart
QuickChart API — сервис для генерации графиков по Chart.js конфигурации.
ChartImageService скачивает изображение по URL.
Отправка графика пользователю.________________________________________
7. Основные пользовательские сценарии
7.1. Регистрация нового пользователя
1.	Пользователь пишет /start боту
2.	Если пользователь новый → запускается RegistrationScenario
3.	Бот запрашивает возраст → город
4.	Сохраняет профиль и показывает главное меню
7.2. Добавление приёма пищи по фото
1.	Пользователь нажимает «📷 Распознать блюдо по фото» или /foodphoto
2.	Отправляет фото блюда
3.	FoodPhotoHandler отправляет фото в LogMeal API
4.	Если получены калории и БЖУ → автоматически создаётся Meal
5.	Если нет данных → предлагается ручной ввод через /addmeal
7.3. Ручное добавление приёма пищи
Вариант 1: Быстрые калории
1.	Пользователь нажимает «🍽️ Добавить еду»
2.	Выбирает пресет (50/100/200/300/500 ккал) или «Другое количество»
3.	При выборе «Другое» → запускается CustomCaloriesScenario
4.	Вводит калории → выбирает «Да/Нет» для БЖУ
5.	Meal сохраняется
Вариант 2: Детальный ввод
1.	Пользователь нажимает «🥗 Приём пищи» или /addmeal
2.	Выбирает режим: «Готовое блюдо» или «По 100 г продукта»
3.	Выбирает тип приёма (завтрак/обед/ужин/перекус)
4.	Вводит калории и БЖУ
5.	Meal сохраняется с полной информацией
7.4. Просмотр статистики и отчётов
Сегодня:
1.	Пользователь нажимает «📊 Сегодня» или /today
2.	Получает текстовый отчёт:
•	Калории: потреблено / сожжено / баланс
•	Шаги
•	БЖУ
Графики:
1.	Пользователь нажимает «📊 Графики» или /charts
2.	Выбирает тип графика (калории/шаги/БЖУ)
3.	Выбирает период (7/14/30 дней)
4.	Получает изображение графика
7.5. Установка дневных целей
1.	Пользователь нажимает «🎯 Цель дня» или /setgoal
2.	Вводит целевые шаги
3.	Вводит целевое потребление калорий
4.	Вводит целевой расход калорий
5.	Цель сохраняется на текущую дату
7.6. Расчёт ИМТ
1.	Пользователь нажимает «⚖️ ИМТ» или /bmi
2.	Вводит рост в сантиметрах
3.	Вводит вес в килограммах
4.	Получает результат: ИМТ, категория, рекомендации
5.	Измерение сохраняется в историю
7.7. Настройка напоминаний
Напоминания о приёмах пищи:
1.	«🕐 Время питания» или /setmeals
2.	Вводит время завтрака, обеда, ужина
3.	Система автоматически отправляет напоминания в указанное время (±15 минут), если не зафиксирован соответствующий приём пищи
Напоминания об активности:
1.	«⏰ Напоминания» или /activity_reminders
2.	Включает/выключает напоминания для разных временных слотов
3.	Система проверяет активность и отправляет напоминания, если пользователь малоактивен
7.8. Подключение Google Fit
1.	«🔗 Google Fit» или /connectgooglefit
2.	Получает OAuth URL
3.	Авторизуется в Google
4.	Вставляет authorization code в бот
5.	Система сохраняет refresh token
6.	Фоновая задача автоматически синхронизирует данные раз в час
________________________________________
8. Административные функции
8.1. Назначение администраторов
Команда /make_admin <telegram_id> назначает пользователя администратором.
8.2. Статистика системы
Активные пользователи:
/admin_activity — количество пользователей с активностью за последние сутки
Распределение по возрасту:
Команда администратора показывает группы: <18, 18-29, 30-44, 45-59, 60+
Распределение по городам:
Топ-10 городов по количеству пользователей
Логи ошибок:
Просмотр последних ошибок системы
________________________________________
9. Безопасность и обработка ошибок
9.1. Валидация данных
•	Все пользовательские вводы проходят валидацию на каждом шаге сценария
•	Калории: > 0
•	Возраст: 18-120
•	Рост: 100-250 см
•	Вес: 30-300 кг
•	Шаги: 0-100000
9.2. Обработка ошибок внешних API
LogMeal API:
•	При недоступности сервиса → предложение ручного ввода
•	При таймауте → повторная попытка с экспоненциальной задержкой
Google Fit API:
•	При невалидном refresh token → сброс GoogleFitRefreshToken и уведомление пользователю о необходимости переподключения
•	При rate limit → пропуск синхронизации до следующего запуска
QuickChart API:
•	При ошибке генерации графика → отправка текстового отчёта вместо изображения
9.3. Логирование
ErrorLog:
Все исключения логируются в таблицу error_logs с полями:
•	Level (Error, Warning, Info)
•	Message
•	StackTrace
•	ContextJson (дополнительная информация)
•	Timestamp
